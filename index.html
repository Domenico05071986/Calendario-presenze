<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0a">
    <title>üí∞ Calendario Presenze</title>
    <style>
        :root { 
            --primary: #FFD700; 
            --primary-dark: #DAA520;
            --success: #32CD32; 
            --bg: #0a0a0a;
            --bg-secondary: #1a1a1a;
            --bg-card: #252525;
            --shadow: rgba(255,215,0,0.2);
            --shadow-gold: rgba(255,215,0,0.4);
            --weekend-bg: #2d1a1a;
            --weekend-text: #ff6b6b;
            --gold: #FFD700;
            --gold-light: #FFF8DC;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2a 100%);
            min-height: 100vh;
            color: var(--text-primary);
            zoom: 0.75;
            padding-bottom: 100px;
        }
        
        /* LOGO EURO SCINTILLANTE */
        .logo-container {
            text-align: center;
            padding: 25px 0 20px 0;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2520 100%);
            border-radius: 0 0 25px 25px;
            box-shadow: 0 6px 25px var(--shadow-gold);
            margin-bottom: 15px;
        }
        
        .euro-logo {
            font-size: 80px;
            animation: sparkle 2.5s ease-in-out infinite;
            display: inline-block;
            font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FFA500, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @keyframes sparkle {
            0%, 100% { 
                filter: 
                    drop-shadow(0 0 15px rgba(255,215,0,0.9))
                    drop-shadow(0 0 30px rgba(255,165,0,0.6))
                    drop-shadow(0 0 45px rgba(255,215,0,0.4));
                transform: scale(1) rotate(0deg);
            }
            50% { 
                filter: 
                    drop-shadow(0 0 25px rgba(255,215,0,1))
                    drop-shadow(0 0 50px rgba(255,165,0,0.8))
                    drop-shadow(0 0 75px rgba(255,215,0,0.6));
                transform: scale(1.08) rotate(5deg);
            }
        }
        
        .logo-title {
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 24px;
            font-weight: 900;
            margin-top: 10px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 2px 10px rgba(255,215,0,0.5);
        }

        /* HEADER FISSO */
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 999;
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2520 100%);
            padding: 12px 10px;
            box-shadow: 0 3px 20px var(--shadow-gold);
            border-bottom: 2px solid var(--gold);
        }

        .controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        #yearSelect {
            padding: 11px 14px;
            border-radius: 10px;
            border: 2px solid var(--gold);
            font-weight: bold;
            font-size: 16px;
            background: var(--bg-secondary);
            color: var(--gold);
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px var(--shadow);
        }
        
        #yearSelect:hover {
            background: var(--bg-card);
            box-shadow: 0 0 25px var(--shadow-gold);
            transform: translateY(-2px);
        }
        
        #yearSelect:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 30px var(--shadow-gold);
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn { 
            padding: 11px 18px; 
            border: none; 
            border-radius: 10px; 
            color: #000; 
            font-weight: 700; 
            font-size: 14px; 
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 3px 15px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            gap: 7px;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 25px rgba(0,0,0,0.6);
        }
        
        .btn:active {
            transform: translateY(0px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }
        
        .btn-save { 
            background: linear-gradient(135deg, #2a2520, #1a1a1a); 
            color: var(--gold);
            border: 2px solid var(--gold);
        }
        .btn-save:hover { 
            background: linear-gradient(135deg, #3a3530, #2a2520);
            box-shadow: 0 6px 25px var(--shadow-gold);
            border-color: var(--primary);
        }
        .btn-load { 
            background: linear-gradient(135deg, #2a2520, #1a1a1a);
            color: var(--gold);
            border: 2px solid var(--gold);
        }
        .btn-load:hover { 
            background: linear-gradient(135deg, #3a3530, #2a2520);
            box-shadow: 0 6px 25px var(--shadow-gold);
            border-color: var(--primary);
        }
        .btn-gdrive { 
            background: linear-gradient(135deg, #2a2520, #1a1a1a);
            color: var(--gold);
            border: 2px solid var(--gold);
        }
        .btn-gdrive:hover { 
            background: linear-gradient(135deg, #3a3530, #2a2520);
            box-shadow: 0 6px 25px var(--shadow-gold);
            border-color: var(--primary);
        }
        .btn-gdrive.syncing { opacity: 0.6; pointer-events: none; }
        .btn-gdrive.connected { 
            background: linear-gradient(135deg, #FFD700, #DAA520);
            color: #000;
            border: 2px solid #FFA500;
        }
        .btn-gdrive.connected:hover {
            background: linear-gradient(135deg, #FFF8DC, #FFD700);
            box-shadow: 0 6px 25px var(--shadow-gold);
            border-color: var(--gold);
        }

        /* STATUS INDICATOR */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--gold);
            padding: 5px 12px;
            background: rgba(255,215,0,0.1);
            border-radius: 15px;
            border: 1px solid var(--gold);
        }
        
        .sync-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--gold);
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px var(--gold);
        }
        
        .sync-indicator.syncing {
            background: #FFA500;
            animation: pulse 0.6s infinite;
            box-shadow: 0 0 15px #FFA500;
        }
        
        .sync-indicator.error {
            background: #ff6b6b;
            animation: none;
            box-shadow: 0 0 10px #ff6b6b;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.8); }
        }

        /* TABELLA OTTIMIZZATA */
        .table-wrapper { 
            overflow-x: auto; 
            background: var(--bg-secondary);
            margin: 0 10px 15px 10px;
            border-radius: 15px;
            box-shadow: 0 4px 20px var(--shadow-gold);
            -webkit-overflow-scrolling: touch;
            border: 2px solid rgba(255,215,0,0.2);
        }
        
        table { 
            border-collapse: collapse; 
            width: 100%;
        }
        
        thead th { 
            background: linear-gradient(135deg, #2a2520, #3a3530);
            color: var(--gold); 
            font-size: 13px; 
            padding: 16px 12px;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 5;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--gold);
        }

        th, td { 
            border: 1px solid rgba(255,215,0,0.1); 
            padding: 8px 10px; 
            text-align: center; 
            min-width: 120px;
        }
        
        /* Colonna date fissa */
        td:first-child, th:first-child { 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            background: linear-gradient(135deg, #2a2520, #3a3020);
            border-right: 3px solid var(--gold); 
            min-width: 100px;
            max-width: 100px;
            font-weight: 700;
            font-size: 14px;
            color: var(--gold);
        }
        
        thead th:first-child {
            z-index: 15;
            background: linear-gradient(135deg, #2a2520, #3a3530);
        }

        /* INPUT OTTIMIZZATI - PI√ô GRANDI */
        input[type="text"] { 
            width: 100%; 
            border: 2px solid rgba(255,215,0,0.3); 
            border-radius: 8px; 
            padding: 14px 10px; 
            text-align: center; 
            font-size: 17px;
            background: var(--bg-card);
            color: var(--text-primary);
            transition: all 0.3s;
            -webkit-appearance: none;
            min-width: 110px;
            max-width: 400px;
            font-weight: 600;
        }
        
        input[type="text"]:focus { 
            outline: none;
            border-color: var(--gold);
            background: var(--bg-secondary);
            box-shadow: 0 0 20px var(--shadow-gold);
            transform: scale(1.05);
        }
        
        /* Input si espande quando contiene molto testo */
        input[type="text"]:not(:placeholder-shown) {
            min-width: 150px;
        }
        
        input[type="number"] {
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid rgba(255,215,0,0.3);
        }
        
        .weekend { 
            background: var(--weekend-bg) !important; 
            color: var(--weekend-text) !important; 
        }
        
        /* RIASSUNTO OTTIMIZZATO */
        .summary { 
            margin: 20px 10px; 
            background: linear-gradient(135deg, #2a2520 0%, #3a3020 100%);
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 6px 25px var(--shadow-gold);
            border: 2px solid var(--gold);
        }
        
        .summary-title {
            font-size: 22px;
            font-weight: 900;
            background: linear-gradient(90deg, #FFD700, #FFA500, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .pay-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 14px;
            padding: 14px;
            background: rgba(255,215,0,0.05);
            border-radius: 12px;
            border: 1px solid rgba(255,215,0,0.2);
            transition: all 0.3s;
        }
        
        .pay-row:hover {
            background: rgba(255,215,0,0.1);
            border-color: var(--gold);
            transform: translateX(5px);
        }
        
        .pay-row span { 
            font-size: 16px; 
            font-weight: 700;
            color: var(--text-primary); 
        }
        
        .pay-row input { 
            width: 160px; 
            border: 2px solid var(--gold); 
            background: var(--bg-card); 
            text-align: right; 
            font-weight: 800;
            color: var(--gold); 
            padding: 12px 14px; 
            border-radius: 10px;
            font-size: 16px;
            box-shadow: 0 0 15px var(--shadow);
        }
        
        .pay-row input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 25px var(--shadow-gold);
        }
        
        .pay-row input::placeholder {
            color: rgba(255,215,0,0.3);
            font-weight: 600;
        }
        
        #ann { 
            color: var(--gold);
            background: linear-gradient(135deg, #2a2520, #3a3020);
            border: 2px solid var(--gold);
            font-size: 18px;
            box-shadow: 0 0 20px var(--shadow-gold);
        }
        
        /* TOAST NOTIFICATIONS */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            color: var(--gold);
            padding: 18px 30px;
            border-radius: 30px;
            box-shadow: 0 6px 30px rgba(0,0,0,0.5);
            z-index: 10000;
            font-weight: 700;
            font-size: 15px;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90%;
            text-align: center;
            border: 2px solid var(--gold);
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success { 
            background: linear-gradient(135deg, #2d4a2d, #1f3d1f);
            color: var(--success);
            border-color: var(--success);
        }
        .toast.error { 
            background: linear-gradient(135deg, #4a2d2d, #3d1f1f);
            color: #ff6b6b;
            border-color: #ff6b6b;
        }
        .toast.info { 
            background: linear-gradient(135deg, #2d3a4a, #1f2a3d);
            color: #4a9eff;
            border-color: #4a9eff;
        }

        /* LOADING SPINNER */
        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,215,0,0.3);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1a1a1a, #2a2520);
            padding: 35px;
            border-radius: 20px;
            max-width: 550px;
            width: 90%;
            box-shadow: 0 15px 50px rgba(255,215,0,0.3);
            border: 2px solid var(--gold);
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 900;
            color: var(--gold);
            margin-bottom: 18px;
            text-align: center;
        }
        
        .modal-text {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 28px;
            line-height: 1.8;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, #4285f4, #3367d6);
            color: white;
        }
        
        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #5a9eff, #4a7fe6);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66,133,244,0.4);
        }
        
        .modal-btn-secondary {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid rgba(255,215,0,0.3);
        }
        
        .modal-btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--gold);
            transform: translateY(-2px);
        }
        
        /* Modal inputs */
        .modal-content input[type="text"] {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 2px solid rgba(255,215,0,0.3);
            padding: 12px;
            font-size: 14px;
        }
        
        .modal-content input[type="text"]:focus {
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--shadow-gold);
        }
        
        .modal-content label {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* TABS MESI IN BASSO */
        .tabs-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: linear-gradient(180deg, #1a1a1a 0%, #2a2520 100%);
            padding: 12px 10px;
            box-shadow: 0 -3px 20px var(--shadow-gold);
            border-top: 2px solid var(--gold);
        }
        
        .tabs { 
            display: flex; 
            overflow-x: auto; 
            gap: 8px; 
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--gold) rgba(255,215,0,0.2);
            -webkit-overflow-scrolling: touch;
            justify-content: center;
        }
        
        .tabs::-webkit-scrollbar { 
            height: 6px;
        }
        
        .tabs::-webkit-scrollbar-track {
            background: rgba(255,215,0,0.1);
            border-radius: 10px;
        }
        
        .tabs::-webkit-scrollbar-thumb {
            background: var(--gold);
            border-radius: 10px;
        }
        
        .tab { 
            flex: 0 0 auto; 
            padding: 12px 24px; 
            background: rgba(255,215,0,0.1); 
            border-radius: 25px; 
            border: 2px solid rgba(255,215,0,0.3); 
            font-size: 15px; 
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .tab:hover {
            background: rgba(255,215,0,0.2);
            border-color: var(--gold);
            transform: translateY(-3px);
        }
        
        .tab:active {
            transform: scale(0.95) translateY(0);
        }
        
        .tab.active { 
            background: linear-gradient(135deg, var(--gold), #FFA500);
            color: #000;
            box-shadow: 0 4px 20px var(--shadow-gold);
            border-color: var(--gold);
            transform: scale(1.08);
        }

        /* RESPONSIVE DESKTOP */
        @media (min-width: 768px) {
            .sticky-top {
                padding: 16px 25px;
            }
            
            .table-wrapper {
                margin: 0 25px 20px 25px;
            }
            
            .summary {
                margin: 25px 25px;
                max-width: 700px;
                margin-left: auto;
                margin-right: auto;
            }
            
            .controls {
                flex-wrap: nowrap;
            }
            
            th, td {
                min-width: 130px;
            }
            
            .btn {
                padding: 13px 22px;
                font-size: 15px;
            }
            
            .logo-container {
                padding: 30px 0 25px 0;
            }
            
            .euro-logo {
                font-size: 100px;
            }
            
            .logo-title {
                font-size: 28px;
            }
        }
        
        @media (min-width: 1024px) {
            body {
                max-width: 1600px;
                margin: 0 auto;
            }
            
            .table-wrapper {
                border-radius: 20px;
            }
        }

        /* ACCESSIBILIT√Ä */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>

<!-- LOGO EURO -->
<div class="logo-container">
    <div class="euro-logo">‚Ç¨</div>
    <div class="logo-title">Calendario Presenze</div>
</div>

<div class="sticky-top">
    <div class="controls">
        <div class="year-selector">
            <select id="yearSelect"></select>
            <div class="sync-status" id="syncStatus" style="display: none;">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncText">Non sincronizzato</span>
            </div>
        </div>
        <div class="button-group">
            <button class="btn btn-gdrive" id="gdriveBtn" onclick="toggleGoogleDrive()" title="Sincronizza con Google Drive">
                <span id="gdriveBtnIcon">‚òÅÔ∏è</span>
                <span id="gdriveBtnText">Drive</span>
            </button>
            <button class="btn btn-save" onclick="exportData()" title="Esporta backup">
                üíæ <span>Backup</span>
            </button>
            <button class="btn btn-load" onclick="document.getElementById('fileIn').click()" title="Carica backup">
                üìÇ <span>Carica</span>
            </button>
            <input type="file" id="fileIn" style="display:none" accept=".json" onchange="importData(event)">
        </div>
    </div>
</div>

<div id="content"></div>

<!-- TABS MESI IN BASSO -->
<div class="tabs-bottom">
    <div class="tabs" id="tabBar"></div>
</div>

<!-- Modal Setup Google Drive -->
<div class="modal" id="setupModal">
    <div class="modal-content">
        <div class="modal-title">üîß Configura Google Drive</div>
        <div class="modal-text">
            Per abilitare la sincronizzazione automatica con Google Drive, devi creare le credenziali API Google.<br><br>
            <strong>Segui questi passaggi:</strong><br>
            1. Vai su <a href="https://console.cloud.google.com/" target="_blank" style="color: var(--gold)">Google Cloud Console</a><br>
            2. Crea un nuovo progetto<br>
            3. Abilita "Google Drive API"<br>
            4. Crea credenziali OAuth 2.0<br>
            5. Copia il Client ID e l'API Key qui sotto
        </div>
        <div style="text-align: left; margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Client ID:</label>
            <input type="text" id="clientIdInput" placeholder="xxx.apps.googleusercontent.com" style="width: 100%; padding: 10px; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px; margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">API Key:</label>
            <input type="text" id="apiKeyInput" placeholder="AIzaSy..." style="width: 100%; padding: 10px; border: 2px solid rgba(255,215,0,0.3); border-radius: 6px;">
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="saveGoogleCredentials()">Salva e Connetti</button>
            <button class="modal-btn modal-btn-secondary" onclick="closeSetupModal()">Annulla</button>
        </div>
    </div>
</div>

<!-- Modal Info -->
<div class="modal" id="infoModal">
    <div class="modal-content">
        <div class="modal-title">‚ÑπÔ∏è Google Drive non configurato</div>
        <div class="modal-text">
            La sincronizzazione con Google Drive non √® ancora attiva.<br><br>
            <strong>Hai due opzioni:</strong><br><br>
            <strong>1. Configura Google Drive (consigliato)</strong><br>
            Sincronizzazione automatica tra tutti i tuoi dispositivi<br><br>
            <strong>2. Usa backup manuali</strong><br>
            Usa i pulsanti üíæ Backup e üìÇ Carica per trasferire i dati manualmente
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="openSetupModal()">Configura Google Drive</button>
            <button class="modal-btn modal-btn-secondary" onclick="closeInfoModal()">Usa Backup Manuali</button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // CONFIGURAZIONE E COSTANTI
    // ============================================
    const RATES = { 
        roma: 100, 
        trasferta: 120, 
        straordinari: 15.60, 
        sabato: 145, 
        domenica: 170, 
        ferie: 100 
    };
    
    const cols = ['roma', 'trasferta', 'straordinari', 'sabato', 'domenica', 'ferie'];
    const colsShort = ['RM', 'TF', 'STR', 'SAB', 'DOM', 'FE'];
    const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const holidays = [
        {m:0, d:1}, {m:0, d:6}, {m:3, d:25}, {m:4, d:1}, {m:5, d:2}, 
        {m:7, d:15}, {m:10, d:1}, {m:11, d:8}, {m:11, d:25}, {m:11, d:26}
    ];
    
    const STORAGE_KEY = 'turni_v4';
    const GDRIVE_FILE_NAME = 'calendario_presenze_data.json';
    const AUTOSAVE_DELAY = 500;
    
    let curYear = new Date().getFullYear();
    let curMonth = new Date().getMonth();
    let autoSaveTimeout = null;
    let lastSaveTime = null;
    let gdriveFileId = null;
    let isGDriveEnabled = false;
    let gapiInited = false;
    let gisInited = false;
    let tokenClient;
    let accessToken = null;

    let CLIENT_ID = localStorage.getItem('gdrive_client_id') || '';
    let API_KEY = localStorage.getItem('gdrive_api_key') || '';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    // ============================================
    // STORAGE MULTIPLO TOKEN (per mobile aggressivi)
    // ============================================
    function saveTokenMultiple(token, expiry) {
        try {
            // Salva in localStorage
            localStorage.setItem('gdrive_access_token', token);
            localStorage.setItem('gdrive_token_expiry', expiry.toString());
            
            // Salva in sessionStorage (backup)
            sessionStorage.setItem('gdrive_access_token', token);
            sessionStorage.setItem('gdrive_token_expiry', expiry.toString());
            
            // Salva in IndexedDB (pi√π persistente su mobile)
            saveTokenToIndexedDB(token, expiry);
            
            console.log('‚úÖ Token salvato in 3 storage');
        } catch (e) {
            console.error('Errore salvataggio token:', e);
        }
    }
    
    function saveTokenToIndexedDB(token, expiry) {
        const request = indexedDB.open('CalendarioPresenze', 1);
        
        request.onupgradeneeded = function(e) {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('tokens')) {
                db.createObjectStore('tokens');
            }
        };
        
        request.onsuccess = function(e) {
            const db = e.target.result;
            const tx = db.transaction('tokens', 'readwrite');
            const store = tx.objectStore('tokens');
            store.put({token: token, expiry: expiry}, 'gdrive_token');
            console.log('‚úÖ Token salvato in IndexedDB');
        };
    }
    
    function loadTokenFromMultiple(callback) {
        // Prova 1: localStorage
        let savedToken = localStorage.getItem('gdrive_access_token');
        let expiryTime = localStorage.getItem('gdrive_token_expiry');
        
        if (!savedToken || !expiryTime) {
            // Prova 2: sessionStorage
            savedToken = sessionStorage.getItem('gdrive_access_token');
            expiryTime = sessionStorage.getItem('gdrive_token_expiry');
            
            if (savedToken && expiryTime) {
                // Ripristina in localStorage
                localStorage.setItem('gdrive_access_token', savedToken);
                localStorage.setItem('gdrive_token_expiry', expiryTime);
                console.log('üì¶ Token recuperato da sessionStorage');
            }
        }
        
        if (!savedToken || !expiryTime) {
            // Prova 3: IndexedDB
            loadTokenFromIndexedDB(callback);
            return;
        }
        
        callback(savedToken, expiryTime);
    }
    
    function loadTokenFromIndexedDB(callback) {
        const request = indexedDB.open('CalendarioPresenze', 1);
        
        request.onsuccess = function(e) {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('tokens')) {
                callback(null, null);
                return;
            }
            
            const tx = db.transaction('tokens', 'readonly');
            const store = tx.objectStore('tokens');
            const getRequest = store.get('gdrive_token');
            
            getRequest.onsuccess = function() {
                if (getRequest.result) {
                    const token = getRequest.result.token;
                    const expiry = getRequest.result.expiry;
                    
                    // Ripristina in localStorage e sessionStorage
                    localStorage.setItem('gdrive_access_token', token);
                    localStorage.setItem('gdrive_token_expiry', expiry.toString());
                    sessionStorage.setItem('gdrive_access_token', token);
                    sessionStorage.setItem('gdrive_token_expiry', expiry.toString());
                    
                    console.log('üì¶ Token recuperato da IndexedDB');
                    callback(token, expiry.toString());
                } else {
                    callback(null, null);
                }
            };
            
            getRequest.onerror = function() {
                callback(null, null);
            };
        };
        
        request.onerror = function() {
            callback(null, null);
        };
    }
    
    function clearAllTokens() {
        localStorage.removeItem('gdrive_access_token');
        localStorage.removeItem('gdrive_token_expiry');
        sessionStorage.removeItem('gdrive_access_token');
        sessionStorage.removeItem('gdrive_token_expiry');
        
        // Cancella da IndexedDB
        const request = indexedDB.open('CalendarioPresenze', 1);
        request.onsuccess = function(e) {
            const db = e.target.result;
            if (db.objectStoreNames.contains('tokens')) {
                const tx = db.transaction('tokens', 'readwrite');
                const store = tx.objectStore('tokens');
                store.delete('gdrive_token');
            }
        };
    }
    function loadGoogleAPIs() {
        const gapiScript = document.createElement('script');
        gapiScript.src = 'https://apis.google.com/js/api.js';
        gapiScript.onload = gapiLoaded;
        document.head.appendChild(gapiScript);

        const gisScript = document.createElement('script');
        gisScript.src = 'https://accounts.google.com/gsi/client';
        gisScript.onload = gisLoaded;
        document.head.appendChild(gisScript);
    }

    function gapiLoaded() {
        if (!API_KEY) return;
        gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
        try {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableGDrive();
        } catch (error) {
            console.error('Errore inizializzazione GAPI:', error);
        }
    }

    function gisLoaded() {
        if (!CLIENT_ID) return;
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '',
        });
        gisInited = true;
        maybeEnableGDrive();
    }

    function maybeEnableGDrive() {
        if (gapiInited && gisInited && CLIENT_ID && API_KEY) {
            updateGDriveButton(true, false);
            restoreSavedToken();
        }
    }
    
    function restoreSavedToken() {
    function restoreSavedToken() {
        loadTokenFromMultiple((savedToken, expiryTime) => {
            if (savedToken && expiryTime) {
                const now = new Date().getTime();
                const expiry = parseInt(expiryTime);
                
                if (now < (expiry - 300000)) {
                    accessToken = savedToken;
                    isGDriveEnabled = true;
                    
                    gapi.client.setToken({access_token: accessToken});
                    
                    updateGDriveButton(true, true);
                    updateSyncStatus('Connesso', 'success');
                    
                    findOrCreateDriveFile().then(() => {
                        return downloadFromDrive();
                    }).then(() => {
                        console.log('‚úÖ Token ripristinato e dati sincronizzati');
                        updateSyncStatus('Sincronizzato', 'success');
                    }).catch((error) => {
                        console.error('‚ùå Errore ripristino:', error);
                        clearAllTokens();
                        accessToken = null;
                        isGDriveEnabled = false;
                        updateGDriveButton(true, false);
                        updateSyncStatus('Richiede autenticazione', 'error');
                        showToast('‚ö†Ô∏è Richiesta nuova autenticazione', 'info');
                    });
                } else {
                    clearAllTokens();
                    console.log('‚ö†Ô∏è Token scaduto');
                }
            }
        });
    }
    }

    // ============================================
    // GOOGLE DRIVE: AUTENTICAZIONE
    // ============================================
    function toggleGoogleDrive() {
        if (!CLIENT_ID || !API_KEY) {
            document.getElementById('infoModal').classList.add('show');
            return;
        }

        if (accessToken) {
            google.accounts.oauth2.revoke(accessToken, () => {
                accessToken = null;
                isGDriveEnabled = false;
                clearAllTokens();
                updateGDriveButton(true, false);
                updateSyncStatus('Non sincronizzato', 'default');
                showToast('üîì Disconnesso da Google Drive', 'info');
            });
        } else {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showToast('‚ùå Errore autenticazione', 'error');
                    return;
                }
                accessToken = resp.access_token;
                isGDriveEnabled = true;
                
                // Salva il token in tutti gli storage (localStorage + sessionStorage + IndexedDB)
                const expiryTime = new Date().getTime() + (resp.expires_in * 1000);
                saveTokenMultiple(accessToken, expiryTime);
                
                updateGDriveButton(true, true);
                showToast('‚úÖ Connesso a Google Drive', 'success');
                
                await findOrCreateDriveFile();
                await downloadFromDrive();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
    }

    // ============================================
    // GOOGLE DRIVE: OPERAZIONI FILE
    // ============================================
    async function findOrCreateDriveFile() {
        try {
            const response = await gapi.client.drive.files.list({
                q: `name='${GDRIVE_FILE_NAME}' and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });

            if (response.result.files && response.result.files.length > 0) {
                gdriveFileId = response.result.files[0].id;
                console.log('File trovato su Drive:', gdriveFileId);
            } else {
                await createDriveFile();
            }
        } catch (error) {
            console.error('Errore ricerca file:', error);
            showToast('‚ö†Ô∏è Errore connessione Drive', 'error');
        }
    }

    async function createDriveFile() {
        try {
            const fileMetadata = {
                name: GDRIVE_FILE_NAME,
                mimeType: 'application/json'
            };

            const currentData = loadFromStorage();
            const content = JSON.stringify(currentData, null, 2);

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
            form.append('file', new Blob([content], {type: 'application/json'}));

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                body: form
            });

            const result = await response.json();
            gdriveFileId = result.id;
            console.log('File creato su Drive:', gdriveFileId);
            showToast('üì§ Dati caricati su Drive', 'success');
        } catch (error) {
            console.error('Errore creazione file:', error);
            showToast('‚ùå Errore caricamento Drive', 'error');
        }
    }

    async function uploadToDrive() {
        if (!accessToken || !gdriveFileId) return;

        try {
            updateSyncStatus('Sincronizzazione...', 'syncing');

            const currentData = loadFromStorage();
            const content = JSON.stringify(currentData, null, 2);

            const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${gdriveFileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }),
                body: content
            });

            if (response.ok) {
                console.log('‚úÖ Dati sincronizzati su Drive');
                updateSyncStatus('Sincronizzato', 'success');
                lastSaveTime = new Date();
            } else {
                throw new Error('Errore upload');
            }
        } catch (error) {
            console.error('Errore upload Drive:', error);
            updateSyncStatus('Errore sincronizzazione', 'error');
            showToast('‚ö†Ô∏è Errore sincronizzazione Drive', 'error');
        }
    }

    async function downloadFromDrive() {
        if (!accessToken || !gdriveFileId) return;

        try {
            updateSyncStatus('Download dati...', 'syncing');

            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${gdriveFileId}?alt=media`, {
                method: 'GET',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken})
            });

            if (response.ok) {
                const driveData = await response.json();
                
                const localData = loadFromStorage();
                const mergedData = {...localData, ...driveData};
                
                saveToStorage(mergedData);
                load();
                
                console.log('‚úÖ Dati scaricati da Drive');
                updateSyncStatus('Sincronizzato', 'success');
                showToast('üì• Dati sincronizzati da Drive', 'success');
            } else {
                throw new Error('Errore download');
            }
        } catch (error) {
            console.error('Errore download Drive:', error);
            updateSyncStatus('Errore download', 'error');
            showToast('‚ö†Ô∏è Errore download da Drive', 'error');
        }
    }

    // ============================================
    // UI: MODALS
    // ============================================
    function openSetupModal() {
        closeInfoModal();
        document.getElementById('setupModal').classList.add('show');
        document.getElementById('clientIdInput').value = CLIENT_ID;
        document.getElementById('apiKeyInput').value = API_KEY;
    }

    function closeSetupModal() {
        document.getElementById('setupModal').classList.remove('show');
    }

    function closeInfoModal() {
        document.getElementById('infoModal').classList.remove('show');
    }

    function saveGoogleCredentials() {
        const clientId = document.getElementById('clientIdInput').value.trim();
        const apiKey = document.getElementById('apiKeyInput').value.trim();

        if (!clientId || !apiKey) {
            showToast('‚ö†Ô∏è Compila entrambi i campi', 'error');
            return;
        }

        CLIENT_ID = clientId;
        API_KEY = apiKey;
        
        localStorage.setItem('gdrive_client_id', clientId);
        localStorage.setItem('gdrive_api_key', apiKey);

        closeSetupModal();
        showToast('‚úÖ Credenziali salvate! Ricarica la pagina.', 'success');
        
        setTimeout(() => location.reload(), 2000);
    }

    function updateGDriveButton(enabled, connected) {
        const btn = document.getElementById('gdriveBtn');
        const icon = document.getElementById('gdriveBtnIcon');
        const text = document.getElementById('gdriveBtnText');

        if (connected) {
            btn.classList.add('connected');
            icon.textContent = '‚úì';
            text.textContent = 'Drive';
        } else if (enabled) {
            btn.classList.remove('connected');
            icon.textContent = '‚òÅÔ∏è';
            text.textContent = 'Connetti';
        } else {
            btn.classList.remove('connected');
            icon.textContent = '‚òÅÔ∏è';
            text.textContent = 'Drive';
        }
    }

    function updateSyncStatus(text, state) {
        const statusEl = document.getElementById('syncStatus');
        const textEl = document.getElementById('syncText');
        const indicator = document.getElementById('syncIndicator');

        if (!statusEl) return;

        statusEl.style.display = 'flex';
        textEl.textContent = text;

        indicator.className = 'sync-indicator';
        if (state === 'syncing') {
            indicator.classList.add('syncing');
        } else if (state === 'error') {
            indicator.classList.add('error');
        }
    }

    // ============================================
    // UTILITY: TOAST NOTIFICATIONS
    // ============================================
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    // ============================================
    // UTILITY: VALIDAZIONE E SICUREZZA DATI
    // ============================================
    function validateData(data) {
        try {
            if (!data || typeof data !== 'object') return false;
            
            for (const year in data) {
                if (year.startsWith('_')) continue;
                if (!/^\d{4}$/.test(year)) return false;
                if (!data[year] || typeof data[year] !== 'object') return false;
                
                for (const month in data[year]) {
                    if (!/^\d{1,2}$/.test(month)) return false;
                    const mData = data[year][month];
                    if (!mData.v || typeof mData.v !== 'object') return false;
                }
            }
            return true;
        } catch (e) {
            console.error('Errore validazione:', e);
            return false;
        }
    }

    function sanitizeValue(value) {
        if (typeof value !== 'string') return '';
        return value.replace(/[<>]/g, '').substring(0, 30);
    }

    // ============================================
    // STORAGE: SALVATAGGIO CON BACKUP
    // ============================================
    function saveToStorage(data) {
        try {
            data._lastModified = new Date().toISOString();
            data._version = 4;
            
            const dataStr = JSON.stringify(data);
            
            if (dataStr.length > 4000000) {
                showToast('‚ö†Ô∏è Dati troppo grandi', 'error');
                return false;
            }
            
            const oldData = localStorage.getItem(STORAGE_KEY);
            if (oldData) {
                localStorage.setItem(STORAGE_KEY + '_backup', oldData);
            }
            
            localStorage.setItem(STORAGE_KEY, dataStr);
            lastSaveTime = new Date();
            
            if (isGDriveEnabled && accessToken) {
                uploadToDrive();
            }
            
            return true;
        } catch (e) {
            console.error('Errore salvataggio:', e);
            showToast('‚ùå Errore nel salvataggio', 'error');
            return false;
        }
    }

    function loadFromStorage() {
        try {
            let dataStr = localStorage.getItem(STORAGE_KEY);
            
            if (!dataStr) {
                const oldData = localStorage.getItem('turni_v3');
                if (oldData) {
                    console.log('Migrazione da turni_v3...');
                    dataStr = oldData;
                    const parsedData = JSON.parse(oldData);
                    saveToStorage(parsedData);
                    showToast('üì¶ Dati migrati', 'info');
                }
            }
            
            if (!dataStr) {
                const backupStr = localStorage.getItem(STORAGE_KEY + '_backup');
                if (backupStr) {
                    showToast('üì¶ Recuperato da backup', 'info');
                    return JSON.parse(backupStr);
                }
                return {};
            }
            
            const data = JSON.parse(dataStr);
            
            if (!validateData(data)) {
                throw new Error('Dati corrotti');
            }
            
            return data;
        } catch (e) {
            console.error('Errore caricamento:', e);
            return {};
        }
    }

    // ============================================
    // INIZIALIZZAZIONE
    // ============================================
    function init() {
        const ys = document.getElementById('yearSelect');
        for (let y = 2024; y <= 2035; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            ys.appendChild(opt);
        }
        ys.value = curYear;
        ys.onchange = (e) => { 
            curYear = parseInt(e.target.value); 
            render(); 
            load(); 
        };
        
        render(); 
        load();
        
        if (CLIENT_ID && API_KEY) {
            loadGoogleAPIs();
        }
        
        setTimeout(() => {
            showToast('‚úÖ Calendario caricato', 'success');
        }, 500);
    }

    // ============================================
    // RENDERING INTERFACCIA
    // ============================================
    function render() {
        const tabBar = document.getElementById('tabBar');
        tabBar.innerHTML = '';
        months.forEach((m, i) => {
            const b = document.createElement('button');
            b.className = 'tab' + (i === curMonth ? ' active' : '');
            b.innerText = m.substring(0, 3);
            b.onclick = () => { 
                curMonth = i; 
                render(); 
                load(); 
            };
            tabBar.appendChild(b);
        });

        const activeTab = tabBar.querySelector('.tab.active');
        if (activeTab) {
            activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }

        const days = new Date(curYear, curMonth + 1, 0).getDate();
        let h = `<div class="table-wrapper"><table>
            <thead>
                <tr>
                    <th>Data</th>`;
        
        colsShort.forEach(c => h += `<th>${c}</th>`);
        h += `</tr></thead><tbody>`;
        
        for (let d = 1; d <= days; d++) {
            const date = new Date(curYear, curMonth, d);
            const dayName = date.toLocaleDateString('it-IT', {weekday: 'short'});
            const isWeekend = date.getDay() === 0 || date.getDay() === 6 || 
                            holidays.some(x => x.m === curMonth && x.d === d);
            
            h += `<tr>
                <td class="${isWeekend ? 'weekend' : ''}">${d} ${dayName}</td>`;
            
            cols.forEach(c => {
                h += `<td><input type="text" 
                    data-d="${d}" 
                    data-c="${c}" 
                    inputmode="${c === 'straordinari' ? 'decimal' : 'text'}"
                    oninput="handleInput(this)"
                    autocomplete="off"
                    maxlength="30"></td>`;
            });
            h += `</tr>`;
        }
        
        // ============================================
        // RIGHE TOTALI MESE
        // ============================================
        let totals = {
            roma: 0,
            trasferta: 0,
            straordinari: 0,
            sabato: 0,
            domenica: 0,
            ferie: 0
        };
        
        // Conta i giorni/ore dai dati salvati
        const data = loadFromStorage();
        if (data[curYear] && data[curYear][curMonth]) {
            const mData = data[curYear][curMonth];
            Object.keys(mData.v).forEach(k => {
                const [d, c] = k.split('-');
                const val = mData.v[k];
                if (val && val.trim() !== '') {
                    if (c === 'straordinari') {
                        totals[c] += parseFloat(val.replace(',', '.')) || 0;
                    } else {
                        totals[c] += 1;
                    }
                }
            });
        }
        
        // RIGA TOTALI - Titolo
        h += `<tr style="background: linear-gradient(135deg, #3a3020, #4a4030); border-top: 3px solid var(--gold);">
            <td colspan="7" style="text-align: center; font-weight: 900; font-size: 16px; padding: 14px; color: var(--gold); text-transform: uppercase; letter-spacing: 2px;">
                üí∞ TOTALI MESE
            </td>
        </tr>`;
        
        // RIGA 1 - Numero giorni/ore
        h += `<tr data-total-type="numbers" style="background: rgba(255,215,0,0.15); border: 2px solid rgba(255,215,0,0.3);">
            <td style="background: rgba(255,215,0,0.1);"></td>`;
        cols.forEach(c => {
            const count = c === 'straordinari' 
                ? totals[c].toFixed(1) 
                : totals[c];
            h += `<td style="font-weight: 800; font-size: 15px; color: var(--gold);">${count > 0 ? count : '-'}</td>`;
        });
        h += `</tr>`;
        
        // RIGA 2 - Importi in euro
        h += `<tr data-total-type="amounts" style="background: rgba(255,215,0,0.1); border: 2px solid rgba(255,215,0,0.3); border-bottom: 3px solid var(--gold);">
            <td style="background: rgba(255,215,0,0.08);"></td>`;
        cols.forEach(c => {
            const amount = totals[c] * RATES[c];
            h += `<td style="font-weight: 800; font-size: 15px; color: #32CD32;">‚Ç¨${amount > 0 ? amount.toFixed(2) : '-'}</td>`;
        });
        h += `</tr>`;
        
        h += `</tbody></table></div>
        <div class="summary">
            <div class="summary-title">üí∞ Riepilogo Economico</div>
            <div class="pay-row">
                <span>Totale mese:</span>
                <input id="totM" type="text" readonly placeholder="‚Ç¨ 0,00">
            </div>
            <div class="pay-row">
                <span>Acconto:</span>
                <input id="acc" type="text" inputmode="decimal" oninput="handleAccontoInput()" onblur="formatAcconto()" placeholder="‚Ç¨ 0,00">
            </div>
            <div class="pay-row">
                <span>Restante mese:</span>
                <input id="res" type="text" readonly placeholder="‚Ç¨ 0,00">
            </div>
            <div class="pay-row">
                <span style="background: linear-gradient(90deg, #FFD700, #FFA500); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">üí∞ Progressivo Anno:</span>
                <input id="ann" type="text" readonly placeholder="‚Ç¨ 0,00">
            </div>
        </div>`;
        
        document.getElementById('content').innerHTML = h;
    }

    // ============================================
    // GESTIONE INPUT
    // ============================================
    function handleInput(input) {
        input.value = sanitizeValue(input.value);
        calc();
        debouncedAutoSave();
    }

    function handleAccontoInput() {
        // Rimuovi tutto tranne numeri, punto e virgola
        const input = document.getElementById('acc');
        let value = input.value.replace(/[^\d.,]/g, '');
        input.value = value;
        
        calc();
        debouncedAutoSave();
    }
    
    function formatAcconto() {
        const input = document.getElementById('acc');
        let value = input.value.replace(/[^\d.,]/g, '');
        
        if (value === '' || value === '0') {
            input.value = '';
            calc();
            return;
        }
        
        // Converti in numero
        const num = parseFloat(value.replace(',', '.'));
        
        if (!isNaN(num) && num > 0) {
            // Formatta con ‚Ç¨ e .00
            input.value = '‚Ç¨ ' + num.toFixed(2);
        }
        
        calc();
    }

    function debouncedAutoSave() {
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        
        autoSaveTimeout = setTimeout(() => {
            autoSave();
        }, AUTOSAVE_DELAY);
    }

    // ============================================
    // CALCOLI
    // ============================================
    function calc() {
        let totalMese = 0;
        
        cols.forEach(c => {
            let q = 0;
            document.querySelectorAll(`input[data-c="${c}"]`).forEach(i => {
                if (i.value !== '') {
                    if (c === 'straordinari') {
                        const val = parseFloat(i.value.replace(',', '.')) || 0;
                        q += val;
                    } else {
                        q += 1;
                    }
                }
            });
            totalMese += (q * RATES[c]);
        });
        
        const acc = parseFloat(document.getElementById('acc').value.replace(/[^\d.,]/g, '').replace(',', '.')) || 0;
        const resto = totalMese - acc;
        
        document.getElementById('totM').value = totalMese > 0 ? '‚Ç¨ ' + totalMese.toFixed(2) : '';
        document.getElementById('res').value = (totalMese > 0 || acc > 0) ? '‚Ç¨ ' + resto.toFixed(2) : '';
        
        let totA = 0;
        const data = loadFromStorage();
        
        // Somma PROGRESSIVA: solo i mesi da gennaio fino al mese corrente
        if (data[curYear]) {
            for (let m = 0; m <= curMonth; m++) {
                if (m === curMonth) { 
                    // Mese corrente: usa il resto calcolato sopra
                    totA += resto; 
                } else if (data[curYear][m]) {
                    // Mesi precedenti: calcola dal localStorage
                    let mTot = 0;
                    const mData = data[curYear][m];
                    
                    cols.forEach(c => {
                        let q = 0;
                        Object.keys(mData.v).forEach(k => { 
                            if (k.endsWith('-' + c)) {
                                if (c === 'straordinari') {
                                    q += parseFloat(mData.v[k]) || 0;
                                } else {
                                    q += 1;
                                }
                            }
                        });
                        mTot += (q * RATES[c]);
                    });
                    
                    totA += (mTot - (parseFloat(mData.a) || 0));
                }
            }
        } else { 
            totA = resto; 
        }
        
        document.getElementById('ann').value = totA !== 0 ? '‚Ç¨ ' + totA.toFixed(2) : '';
        
        // ============================================
        // AGGIORNA RIGHE TOTALI IN TEMPO REALE
        // ============================================
        updateMonthTotals();
    }
    
    function updateMonthTotals() {
        // Calcola totali dalle caselle visibili (non da localStorage)
        let totals = {
            roma: 0,
            trasferta: 0,
            straordinari: 0,
            sabato: 0,
            domenica: 0,
            ferie: 0
        };
        
        cols.forEach(c => {
            document.querySelectorAll(`input[data-c="${c}"]`).forEach(i => {
                if (i.value && i.value.trim() !== '') {
                    if (c === 'straordinari') {
                        totals[c] += parseFloat(i.value.replace(',', '.')) || 0;
                    } else {
                        totals[c] += 1;
                    }
                }
            });
        });
        
        // Aggiorna celle dei numeri (prima riga totali)
        const numberCells = document.querySelectorAll('tr[data-total-type="numbers"] td');
        if (numberCells.length > 0) {
            cols.forEach((c, idx) => {
                const count = c === 'straordinari' 
                    ? totals[c].toFixed(1) 
                    : totals[c];
                numberCells[idx + 1].textContent = count > 0 ? count : '-';
            });
        }
        
        // Aggiorna celle degli importi (seconda riga totali)
        const amountCells = document.querySelectorAll('tr[data-total-type="amounts"] td');
        if (amountCells.length > 0) {
            cols.forEach((c, idx) => {
                const amount = totals[c] * RATES[c];
                amountCells[idx + 1].textContent = amount > 0 ? '‚Ç¨' + amount.toFixed(2) : '-';
            });
        }
    }

    // ============================================
    // SALVATAGGIO AUTOMATICO
    // ============================================
    function autoSave() {
        try {
            let data = loadFromStorage();
            
            if (!data[curYear]) data[curYear] = {};
            if (!data[curYear][curMonth]) data[curYear][curMonth] = { v: {}, a: 0 };
            
            let currentValues = {};
            document.querySelectorAll('input[data-d]').forEach(i => {
                if (i.value !== '') {
                    currentValues[i.dataset.d + '-' + i.dataset.c] = sanitizeValue(i.value);
                }
            });
            
            data[curYear][curMonth].v = currentValues;
            data[curYear][curMonth].a = document.getElementById('acc').value;
            
            if (saveToStorage(data)) {
                console.log('‚úÖ Autosalvataggio completato');
            }
        } catch (e) {
            console.error('Errore autosalvataggio:', e);
        }
    }

    // ============================================
    // CARICAMENTO DATI
    // ============================================
    function load() {
        const data = loadFromStorage();
        console.log('üìÇ Caricamento dati per anno:', curYear, 'mese:', curMonth);
        
        if (data[curYear] && data[curYear][curMonth]) {
            const mData = data[curYear][curMonth];
            console.log('‚úÖ Dati trovati per il mese corrente:', mData);
            
            let loadedCount = 0;
            Object.keys(mData.v).forEach(k => {
                const [d, c] = k.split('-');
                const inp = document.querySelector(`input[data-d="${d}"][data-c="${c}"]`);
                if (inp) {
                    inp.value = mData.v[k];
                    loadedCount++;
                }
            });
            
            console.log(`üìä Caricati ${loadedCount} valori`);
            
            const accInput = document.getElementById('acc');
            if (accInput && mData.a) {
                // Rimuovi ‚Ç¨ e formatta se necessario
                const accValue = mData.a.toString().replace(/[^\d.,]/g, '');
                const accNum = parseFloat(accValue.replace(',', '.'));
                if (!isNaN(accNum) && accNum > 0) {
                    accInput.value = '‚Ç¨ ' + accNum.toFixed(2);
                } else {
                    accInput.value = '';
                }
            }
        } else {
            console.log('‚ÑπÔ∏è Nessun dato per questo mese');
        }
        
        calc();
    }

    // ============================================
    // ESPORTAZIONE/IMPORTAZIONE
    // ============================================
    function exportData() {
        try {
            const dataStr = localStorage.getItem(STORAGE_KEY);
            if (!dataStr) {
                showToast('‚ö†Ô∏è Nessun dato da esportare', 'error');
                return;
            }
            
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('it-IT').replace(/\//g, '-');
            const timeStr = now.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}).replace(/:/g, '-');
            
            a.href = url;
            a.download = `Calendario_Presenze_${dateStr}_${timeStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('‚úÖ Backup esportato!', 'success');
        } catch (e) {
            console.error('Errore esportazione:', e);
            showToast('‚ùå Errore esportazione', 'error');
        }
    }

    function importData(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.json')) {
            showToast('‚ö†Ô∏è Seleziona un file .json', 'error');
            e.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = (ev) => {
            try {
                let importedData;
                try {
                    importedData = JSON.parse(ev.target.result);
                } catch (parseError) {
                    showToast('‚ùå File JSON non valido', 'error');
                    e.target.value = '';
                    return;
                }
                
                if (!validateData(importedData)) {
                    showToast('‚ùå Struttura dati non valida', 'error');
                    e.target.value = '';
                    return;
                }
                
                const existingData = localStorage.getItem(STORAGE_KEY);
                if (existingData) {
                    if (!confirm('‚ö†Ô∏è Sovrascrivere i dati esistenti?')) {
                        e.target.value = '';
                        return;
                    }
                }
                
                if (saveToStorage(importedData)) {
                    load();
                    showToast('‚úÖ Dati importati!', 'success');
                } else {
                    throw new Error('Errore salvataggio');
                }
            } catch (error) {
                console.error('Errore importazione:', error);
                showToast('‚ùå Errore importazione', 'error');
            } finally {
                e.target.value = '';
            }
        };
        
        reader.onerror = () => {
            showToast('‚ùå Errore lettura file', 'error');
            e.target.value = '';
        };
        
        reader.readAsText(file);
    }

    // ============================================
    // AVVIO APPLICAZIONE
    // ============================================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    window.addEventListener('beforeunload', (e) => {
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
            autoSave();
        }
    });
</script>
</body>
</html>
