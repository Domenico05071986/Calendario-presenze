<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#007bff">
    <title>Calendario Presenze - Cloud Sync</title>
    <style>
        :root { 
            --primary: #007bff; 
            --primary-dark: #0056b3;
            --success: #28a745; 
            --bg: #f4f7f6; 
            --shadow: rgba(0,0,0,0.1);
            --weekend-bg: #ffebee;
            --weekend-text: #c62828;
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent; 
        }
        
        body { 
            background: var(--bg); 
            padding-bottom: 20px;
            min-height: 100vh;
        }

        /* HEADER FISSO OTTIMIZZATO */
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: white;
            padding: 12px 10px;
            box-shadow: 0 2px 12px var(--shadow);
        }

        .controls { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px; 
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .year-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #yearSelect {
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid #ddd;
            font-weight: bold;
            font-size: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #yearSelect:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .btn { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 8px; 
            color: white; 
            font-weight: 600; 
            font-size: 13px; 
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px var(--shadow);
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .btn:active {
            transform: translateY(1px);
            box-shadow: 0 1px 2px var(--shadow);
        }
        
        .btn-save { background: var(--success); }
        .btn-save:hover { background: #218838; }
        .btn-load { background: #6c757d; }
        .btn-load:hover { background: #5a6268; }
        .btn-gdrive { background: #4285f4; }
        .btn-gdrive:hover { background: #3367d6; }
        .btn-gdrive.syncing { opacity: 0.6; pointer-events: none; }
        .btn-gdrive.connected { background: #34a853; }

        /* STATUS INDICATOR */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
            color: #666;
            padding: 4px 8px;
            background: #f0f0f0;
            border-radius: 12px;
        }
        
        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        .sync-indicator.syncing {
            background: #ffc107;
            animation: pulse 0.5s infinite;
        }
        
        .sync-indicator.error {
            background: #dc3545;
            animation: none;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* TABS MESI OTTIMIZZATI */
        .tabs { 
            display: flex; 
            overflow-x: auto; 
            gap: 6px; 
            padding-bottom: 8px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary) #f0f0f0;
            -webkit-overflow-scrolling: touch;
        }
        
        .tabs::-webkit-scrollbar { 
            height: 4px;
        }
        
        .tabs::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 10px;
        }
        
        .tabs::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 10px;
        }
        
        .tab { 
            flex: 0 0 auto; 
            padding: 10px 20px; 
            background: #eee; 
            border-radius: 20px; 
            border: none; 
            font-size: 14px; 
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        
        .tab:active {
            transform: scale(0.95);
        }
        
        .tab.active { 
            background: var(--primary); 
            color: white;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }

        /* TABELLA OTTIMIZZATA PER MOBILE */
        .table-wrapper { 
            overflow-x: auto; 
            background: white;
            margin: 0 10px;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow);
            -webkit-overflow-scrolling: touch;
        }
        
        table { 
            border-collapse: collapse; 
            width: 100%;
        }
        
        thead th { 
            background: #2c3e50; 
            color: white; 
            font-size: 12px; 
            padding: 14px 10px;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        th, td { 
            border: 1px solid #eee; 
            padding: 12px 10px; 
            text-align: center; 
            min-width: 90px;
        }
        
        /* Colonna date fissa ottimizzata */
        td:first-child, th:first-child { 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            background: #ecf0f1; 
            border-right: 3px solid #bdc3c7; 
            min-width: 90px;
            max-width: 90px;
            font-weight: 600;
            font-size: 13px;
        }
        
        thead th:first-child {
            z-index: 15;
            background: #2c3e50;
        }

        /* INPUT OTTIMIZZATI PER TOUCH */
        input[type="text"] { 
            width: 100%; 
            border: 2px solid #ddd; 
            border-radius: 6px; 
            padding: 12px 8px; 
            text-align: center; 
            font-size: 16px;
            background: white;
            transition: all 0.2s;
            -webkit-appearance: none;
        }
        
        input[type="text"]:focus { 
            outline: none;
            border-color: var(--primary);
            background: #f8f9fa;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }
        
        input[type="number"] {
            -webkit-appearance: none;
            appearance: none;
        }
        
        .weekend { 
            background: var(--weekend-bg) !important; 
            color: var(--weekend-text) !important; 
        }
        
        /* RIASSUNTO OTTIMIZZATO */
        .summary { 
            margin: 20px 10px; 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 20px; 
            border-radius: 16px; 
            box-shadow: 0 4px 12px var(--shadow);
        }
        
        .summary-title {
            font-size: 18px;
            font-weight: 700;
            color: #0d47a1;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .pay-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 12px;
            padding: 10px;
            background: white;
            border-radius: 10px;
        }
        
        .pay-row span { 
            font-size: 15px; 
            font-weight: 600;
            color: #333; 
        }
        
        .pay-row input { 
            width: 140px; 
            border: 2px solid #e0e0e0; 
            background: white; 
            text-align: right; 
            font-weight: 700;
            color: #222; 
            padding: 10px 12px; 
            border-radius: 8px;
            font-size: 15px;
        }
        
        .pay-row input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        #ann { 
            color: #0d47a1; 
            background: #bbdefb; 
            border: 2px solid #90caf9;
            font-size: 16px;
        }
        
        /* TOAST NOTIFICATIONS */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10000;
            font-weight: 600;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90%;
            text-align: center;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
        
        .toast.success { background: var(--success); }
        .toast.error { background: #dc3545; }
        .toast.info { background: #17a2b8; }

        /* LOADING SPINNER */
        .spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* MODAL GOOGLE DRIVE */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
        }
        
        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }
        
        .modal-text {
            font-size: 15px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .modal-btn-primary {
            background: #4285f4;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background: #3367d6;
        }
        
        .modal-btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .modal-btn-secondary:hover {
            background: #e0e0e0;
        }

        /* RESPONSIVE DESKTOP */
        @media (min-width: 768px) {
            .sticky-top {
                padding: 15px 20px;
            }
            
            .table-wrapper {
                margin: 0 20px;
            }
            
            .summary {
                margin: 20px 20px;
                max-width: 600px;
                margin-left: auto;
                margin-right: auto;
            }
            
            .controls {
                flex-wrap: nowrap;
            }
            
            th, td {
                min-width: 100px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }
        }
        
        @media (min-width: 1024px) {
            body {
                max-width: 1400px;
                margin: 0 auto;
            }
            
            .table-wrapper {
                border-radius: 16px;
            }
        }

        /* MIGLIORIE ACCESSIBILIT√Ä */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>

<div class="sticky-top">
    <div class="controls">
        <div class="year-selector">
            <select id="yearSelect"></select>
            <div class="sync-status" id="syncStatus" style="display: none;">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncText">Non sincronizzato</span>
            </div>
        </div>
        <div class="button-group">
            <button class="btn btn-gdrive" id="gdriveBtn" onclick="toggleGoogleDrive()" title="Sincronizza con Google Drive">
                <span id="gdriveBtnIcon">‚òÅÔ∏è</span>
                <span id="gdriveBtnText">Drive</span>
            </button>
            <button class="btn btn-save" onclick="exportData()" title="Esporta backup">
                üíæ <span>Backup</span>
            </button>
            <button class="btn btn-load" onclick="document.getElementById('fileIn').click()" title="Carica backup">
                üìÇ <span>Carica</span>
            </button>
            <input type="file" id="fileIn" style="display:none" accept=".json" onchange="importData(event)">
        </div>
    </div>
    <div class="tabs" id="tabBar"></div>
</div>

<div id="content"></div>

<!-- Modal Setup Google Drive -->
<div class="modal" id="setupModal">
    <div class="modal-content">
        <div class="modal-title">üîß Configura Google Drive</div>
        <div class="modal-text">
            Per abilitare la sincronizzazione automatica con Google Drive, devi creare le credenziali API Google.<br><br>
            <strong>Segui questi passaggi:</strong><br>
            1. Vai su <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
            2. Crea un nuovo progetto<br>
            3. Abilita "Google Drive API"<br>
            4. Crea credenziali OAuth 2.0<br>
            5. Copia il Client ID e l'API Key qui sotto
        </div>
        <div style="text-align: left; margin: 20px 0;">
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">Client ID:</label>
            <input type="text" id="clientIdInput" placeholder="xxx.apps.googleusercontent.com" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px;">
            
            <label style="display: block; margin-bottom: 5px; font-weight: 600;">API Key:</label>
            <input type="text" id="apiKeyInput" placeholder="AIzaSy..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 6px;">
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="saveGoogleCredentials()">Salva e Connetti</button>
            <button class="modal-btn modal-btn-secondary" onclick="closeSetupModal()">Annulla</button>
        </div>
    </div>
</div>

<!-- Modal Info -->
<div class="modal" id="infoModal">
    <div class="modal-content">
        <div class="modal-title">‚ÑπÔ∏è Google Drive non configurato</div>
        <div class="modal-text">
            La sincronizzazione con Google Drive non √® ancora attiva.<br><br>
            <strong>Hai due opzioni:</strong><br><br>
            <strong>1. Configura Google Drive (consigliato)</strong><br>
            Sincronizzazione automatica tra tutti i tuoi dispositivi<br><br>
            <strong>2. Usa backup manuali</strong><br>
            Usa i pulsanti üíæ Backup e üìÇ Carica per trasferire i dati manualmente
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-primary" onclick="openSetupModal()">Configura Google Drive</button>
            <button class="modal-btn modal-btn-secondary" onclick="closeInfoModal()">Usa Backup Manuali</button>
        </div>
    </div>
</div>

<script>
    // ============================================
    // CONFIGURAZIONE E COSTANTI
    // ============================================
    const RATES = { 
        roma: 100, 
        trasferta: 120, 
        straordinari: 15.60, 
        sabato: 145, 
        domenica: 170, 
        ferie: 100 
    };
    
    const cols = ['roma', 'trasferta', 'straordinari', 'sabato', 'domenica', 'ferie'];
    const colsShort = ['RM', 'TF', 'STR', 'SAB', 'DOM', 'FE'];
    const months = ['Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    const holidays = [
        {m:0, d:1}, {m:0, d:6}, {m:3, d:25}, {m:4, d:1}, {m:5, d:2}, 
        {m:7, d:15}, {m:10, d:1}, {m:11, d:8}, {m:11, d:25}, {m:11, d:26}
    ];
    
    const STORAGE_KEY = 'turni_v4';
    const GDRIVE_FILE_NAME = 'calendario_presenze_data.json';
    const AUTOSAVE_DELAY = 500;
    
    let curYear = new Date().getFullYear();
    let curMonth = new Date().getMonth();
    let autoSaveTimeout = null;
    let lastSaveTime = null;
    let gdriveFileId = null;
    let isGDriveEnabled = false;
    let gapiInited = false;
    let gisInited = false;
    let tokenClient;
    let accessToken = null;

    // Credenziali Google (da configurare dall'utente)
    let CLIENT_ID = localStorage.getItem('gdrive_client_id') || '';
    let API_KEY = localStorage.getItem('gdrive_api_key') || '';
    const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    // ============================================
    // GOOGLE DRIVE: INIZIALIZZAZIONE
    // ============================================
    function loadGoogleAPIs() {
        // Carica Google API
        const gapiScript = document.createElement('script');
        gapiScript.src = 'https://apis.google.com/js/api.js';
        gapiScript.onload = gapiLoaded;
        document.head.appendChild(gapiScript);

        // Carica Google Identity Services
        const gisScript = document.createElement('script');
        gisScript.src = 'https://accounts.google.com/gsi/client';
        gisScript.onload = gisLoaded;
        document.head.appendChild(gisScript);
    }

    function gapiLoaded() {
        if (!API_KEY) return;
        gapi.load('client', initializeGapiClient);
    }

    async function initializeGapiClient() {
        try {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: [DISCOVERY_DOC],
            });
            gapiInited = true;
            maybeEnableGDrive();
        } catch (error) {
            console.error('Errore inizializzazione GAPI:', error);
        }
    }

    function gisLoaded() {
        if (!CLIENT_ID) return;
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: '', // definito dopo
        });
        gisInited = true;
        maybeEnableGDrive();
    }

    function maybeEnableGDrive() {
        if (gapiInited && gisInited && CLIENT_ID && API_KEY) {
            updateGDriveButton(true, false);
            
            // Prova a ripristinare il token salvato
            restoreSavedToken();
        }
    }
    
    function restoreSavedToken() {
        const savedToken = localStorage.getItem('gdrive_access_token');
        const expiryTime = localStorage.getItem('gdrive_token_expiry');
        
        if (savedToken && expiryTime) {
            const now = new Date().getTime();
            const expiry = parseInt(expiryTime);
            
            // Se il token √® ancora valido (con 5 minuti di margine)
            if (now < (expiry - 300000)) {
                accessToken = savedToken;
                isGDriveEnabled = true;
                updateGDriveButton(true, true);
                updateSyncStatus('Connesso', 'success');
                
                // Trova il file su Drive
                findOrCreateDriveFile().then(() => {
                    console.log('‚úÖ Token ripristinato e connesso a Google Drive');
                });
            } else {
                // Token scaduto, rimuovilo
                localStorage.removeItem('gdrive_access_token');
                localStorage.removeItem('gdrive_token_expiry');
                console.log('‚ö†Ô∏è Token scaduto, richiesta nuova autorizzazione');
            }
        }
    }

    // ============================================
    // GOOGLE DRIVE: AUTENTICAZIONE
    // ============================================
    function toggleGoogleDrive() {
        if (!CLIENT_ID || !API_KEY) {
            document.getElementById('infoModal').classList.add('show');
            return;
        }

        if (accessToken) {
            // Gi√† connesso, disconnetti
            google.accounts.oauth2.revoke(accessToken, () => {
                accessToken = null;
                isGDriveEnabled = false;
                localStorage.removeItem('gdrive_access_token');
                localStorage.removeItem('gdrive_token_expiry');
                updateGDriveButton(true, false);
                updateSyncStatus('Non sincronizzato', 'default');
                showToast('üîì Disconnesso da Google Drive', 'info');
            });
        } else {
            // Richiedi autenticazione
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showToast('‚ùå Errore autenticazione', 'error');
                    return;
                }
                accessToken = resp.access_token;
                isGDriveEnabled = true;
                
                // Salva il token e la scadenza
                localStorage.setItem('gdrive_access_token', accessToken);
                const expiryTime = new Date().getTime() + (resp.expires_in * 1000);
                localStorage.setItem('gdrive_token_expiry', expiryTime.toString());
                
                updateGDriveButton(true, true);
                showToast('‚úÖ Connesso a Google Drive', 'success');
                
                // Trova o crea il file su Drive
                await findOrCreateDriveFile();
                
                // Scarica dati da Drive
                await downloadFromDrive();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
    }

    // ============================================
    // GOOGLE DRIVE: OPERAZIONI FILE
    // ============================================
    async function findOrCreateDriveFile() {
        try {
            // Cerca il file esistente
            const response = await gapi.client.drive.files.list({
                q: `name='${GDRIVE_FILE_NAME}' and trashed=false`,
                fields: 'files(id, name)',
                spaces: 'drive'
            });

            if (response.result.files && response.result.files.length > 0) {
                gdriveFileId = response.result.files[0].id;
                console.log('File trovato su Drive:', gdriveFileId);
            } else {
                // Crea nuovo file
                await createDriveFile();
            }
        } catch (error) {
            console.error('Errore ricerca file:', error);
            showToast('‚ö†Ô∏è Errore connessione Drive', 'error');
        }
    }

    async function createDriveFile() {
        try {
            const fileMetadata = {
                name: GDRIVE_FILE_NAME,
                mimeType: 'application/json'
            };

            const currentData = loadFromStorage();
            const content = JSON.stringify(currentData, null, 2);

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(fileMetadata)], {type: 'application/json'}));
            form.append('file', new Blob([content], {type: 'application/json'}));

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken}),
                body: form
            });

            const result = await response.json();
            gdriveFileId = result.id;
            console.log('File creato su Drive:', gdriveFileId);
            showToast('üì§ Dati caricati su Drive', 'success');
        } catch (error) {
            console.error('Errore creazione file:', error);
            showToast('‚ùå Errore caricamento Drive', 'error');
        }
    }

    async function uploadToDrive() {
        if (!accessToken || !gdriveFileId) return;

        try {
            updateSyncStatus('Sincronizzazione...', 'syncing');

            const currentData = loadFromStorage();
            const content = JSON.stringify(currentData, null, 2);

            const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${gdriveFileId}?uploadType=media`, {
                method: 'PATCH',
                headers: new Headers({
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                }),
                body: content
            });

            if (response.ok) {
                console.log('‚úÖ Dati sincronizzati su Drive');
                updateSyncStatus('Sincronizzato', 'success');
                lastSaveTime = new Date();
            } else {
                throw new Error('Errore upload');
            }
        } catch (error) {
            console.error('Errore upload Drive:', error);
            updateSyncStatus('Errore sincronizzazione', 'error');
            showToast('‚ö†Ô∏è Errore sincronizzazione Drive', 'error');
        }
    }

    async function downloadFromDrive() {
        if (!accessToken || !gdriveFileId) return;

        try {
            updateSyncStatus('Download dati...', 'syncing');

            const response = await fetch(`https://www.googleapis.com/drive/v3/files/${gdriveFileId}?alt=media`, {
                method: 'GET',
                headers: new Headers({'Authorization': 'Bearer ' + accessToken})
            });

            if (response.ok) {
                const driveData = await response.json();
                
                // Merge con dati locali (Drive ha priorit√†)
                const localData = loadFromStorage();
                const mergedData = {...localData, ...driveData};
                
                saveToStorage(mergedData);
                load();
                
                console.log('‚úÖ Dati scaricati da Drive');
                updateSyncStatus('Sincronizzato', 'success');
                showToast('üì• Dati sincronizzati da Drive', 'success');
            } else {
                throw new Error('Errore download');
            }
        } catch (error) {
            console.error('Errore download Drive:', error);
            updateSyncStatus('Errore download', 'error');
            showToast('‚ö†Ô∏è Errore download da Drive', 'error');
        }
    }

    // ============================================
    // UI: MODALS
    // ============================================
    function openSetupModal() {
        closeInfoModal();
        document.getElementById('setupModal').classList.add('show');
        document.getElementById('clientIdInput').value = CLIENT_ID;
        document.getElementById('apiKeyInput').value = API_KEY;
    }

    function closeSetupModal() {
        document.getElementById('setupModal').classList.remove('show');
    }

    function closeInfoModal() {
        document.getElementById('infoModal').classList.remove('show');
    }

    function saveGoogleCredentials() {
        const clientId = document.getElementById('clientIdInput').value.trim();
        const apiKey = document.getElementById('apiKeyInput').value.trim();

        if (!clientId || !apiKey) {
            showToast('‚ö†Ô∏è Compila entrambi i campi', 'error');
            return;
        }

        CLIENT_ID = clientId;
        API_KEY = apiKey;
        
        localStorage.setItem('gdrive_client_id', clientId);
        localStorage.setItem('gdrive_api_key', apiKey);

        closeSetupModal();
        showToast('‚úÖ Credenziali salvate! Ricarica la pagina.', 'success');
        
        setTimeout(() => location.reload(), 2000);
    }

    function updateGDriveButton(enabled, connected) {
        const btn = document.getElementById('gdriveBtn');
        const icon = document.getElementById('gdriveBtnIcon');
        const text = document.getElementById('gdriveBtnText');

        if (connected) {
            btn.classList.add('connected');
            icon.textContent = '‚úì';
            text.textContent = 'Drive';
        } else if (enabled) {
            btn.classList.remove('connected');
            icon.textContent = '‚òÅÔ∏è';
            text.textContent = 'Connetti';
        } else {
            btn.classList.remove('connected');
            icon.textContent = '‚òÅÔ∏è';
            text.textContent = 'Drive';
        }
    }

    function updateSyncStatus(text, state) {
        const statusEl = document.getElementById('syncStatus');
        const textEl = document.getElementById('syncText');
        const indicator = document.getElementById('syncIndicator');

        if (!statusEl) return;

        statusEl.style.display = 'flex';
        textEl.textContent = text;

        indicator.className = 'sync-indicator';
        if (state === 'syncing') {
            indicator.classList.add('syncing');
        } else if (state === 'error') {
            indicator.classList.add('error');
        }
    }

    // ============================================
    // UTILITY: TOAST NOTIFICATIONS
    // ============================================
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ============================================
    // UTILITY: VALIDAZIONE E SICUREZZA DATI
    // ============================================
    function validateData(data) {
        try {
            if (!data || typeof data !== 'object') return false;
            
            for (const year in data) {
                if (year.startsWith('_')) continue;
                if (!/^\d{4}$/.test(year)) return false;
                if (!data[year] || typeof data[year] !== 'object') return false;
                
                for (const month in data[year]) {
                    if (!/^\d{1,2}$/.test(month)) return false;
                    const mData = data[year][month];
                    if (!mData.v || typeof mData.v !== 'object') return false;
                }
            }
            return true;
        } catch (e) {
            console.error('Errore validazione:', e);
            return false;
        }
    }

    function sanitizeValue(value) {
        if (typeof value !== 'string') return '';
        return value.replace(/[<>]/g, '').substring(0, 10);
    }

    // ============================================
    // STORAGE: SALVATAGGIO CON BACKUP
    // ============================================
    function saveToStorage(data) {
        try {
            data._lastModified = new Date().toISOString();
            data._version = 4;
            
            const dataStr = JSON.stringify(data);
            
            if (dataStr.length > 4000000) {
                showToast('‚ö†Ô∏è Dati troppo grandi', 'error');
                return false;
            }
            
            const oldData = localStorage.getItem(STORAGE_KEY);
            if (oldData) {
                localStorage.setItem(STORAGE_KEY + '_backup', oldData);
            }
            
            localStorage.setItem(STORAGE_KEY, dataStr);
            lastSaveTime = new Date();
            
            // Sincronizza con Google Drive se abilitato
            if (isGDriveEnabled && accessToken) {
                uploadToDrive();
            }
            
            return true;
        } catch (e) {
            console.error('Errore salvataggio:', e);
            showToast('‚ùå Errore nel salvataggio', 'error');
            return false;
        }
    }

    function loadFromStorage() {
        try {
            let dataStr = localStorage.getItem(STORAGE_KEY);
            
            if (!dataStr) {
                const oldData = localStorage.getItem('turni_v3');
                if (oldData) {
                    console.log('Migrazione da turni_v3...');
                    dataStr = oldData;
                    const parsedData = JSON.parse(oldData);
                    saveToStorage(parsedData);
                    showToast('üì¶ Dati migrati', 'info');
                }
            }
            
            if (!dataStr) {
                const backupStr = localStorage.getItem(STORAGE_KEY + '_backup');
                if (backupStr) {
                    showToast('üì¶ Recuperato da backup', 'info');
                    return JSON.parse(backupStr);
                }
                return {};
            }
            
            const data = JSON.parse(dataStr);
            
            if (!validateData(data)) {
                throw new Error('Dati corrotti');
            }
            
            return data;
        } catch (e) {
            console.error('Errore caricamento:', e);
            return {};
        }
    }

    // ============================================
    // INIZIALIZZAZIONE
    // ============================================
    function init() {
        const ys = document.getElementById('yearSelect');
        for (let y = 2024; y <= 2035; y++) {
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            ys.appendChild(opt);
        }
        ys.value = curYear;
        ys.onchange = (e) => { 
            curYear = parseInt(e.target.value); 
            render(); 
            load(); 
        };
        
        render(); 
        load();
        
        // Carica Google APIs se configurato
        if (CLIENT_ID && API_KEY) {
            loadGoogleAPIs();
        }
        
        setTimeout(() => {
            showToast('‚úÖ Calendario caricato', 'success');
        }, 500);
    }

    // ============================================
    // RENDERING INTERFACCIA
    // ============================================
    function render() {
        const tabBar = document.getElementById('tabBar');
        tabBar.innerHTML = '';
        months.forEach((m, i) => {
            const b = document.createElement('button');
            b.className = 'tab' + (i === curMonth ? ' active' : '');
            b.innerText = m.substring(0, 3);
            b.onclick = () => { 
                curMonth = i; 
                render(); 
                load(); 
            };
            tabBar.appendChild(b);
        });

        const activeTab = tabBar.querySelector('.tab.active');
        if (activeTab) {
            activeTab.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        }

        const days = new Date(curYear, curMonth + 1, 0).getDate();
        let h = `<div class="table-wrapper"><table>
            <thead>
                <tr>
                    <th>Data</th>`;
        
        colsShort.forEach(c => h += `<th>${c}</th>`);
        h += `</tr></thead><tbody>`;
        
        for (let d = 1; d <= days; d++) {
            const date = new Date(curYear, curMonth, d);
            const dayName = date.toLocaleDateString('it-IT', {weekday: 'short'});
            const isWeekend = date.getDay() === 0 || date.getDay() === 6 || 
                            holidays.some(x => x.m === curMonth && x.d === d);
            
            h += `<tr>
                <td class="${isWeekend ? 'weekend' : ''}">${d} ${dayName}</td>`;
            
            cols.forEach(c => {
                h += `<td><input type="text" 
                    data-d="${d}" 
                    data-c="${c}" 
                    inputmode="${c === 'straordinari' ? 'decimal' : 'text'}"
                    oninput="handleInput(this)"
                    autocomplete="off"></td>`;
            });
            h += `</tr>`;
        }
        
        h += `</tbody></table></div>
        <div class="summary">
            <div class="summary-title">üí∞ Riepilogo Economico</div>
            <div class="pay-row">
                <span>Totale mese:</span>
                <input id="totM" type="text" readonly>
            </div>
            <div class="pay-row">
                <span>Acconto:</span>
                <input id="acc" type="number" inputmode="decimal" oninput="handleAccontoInput()" placeholder="‚Ç¨ 0.00">
            </div>
            <div class="pay-row">
                <span>Restante mese:</span>
                <input id="res" type="text" readonly>
            </div>
            <div class="pay-row">
                <span style="color:#0d47a1">üíº Restante anno:</span>
                <input id="ann" type="text" readonly>
            </div>
        </div>`;
        
        document.getElementById('content').innerHTML = h;
    }

    // ============================================
    // GESTIONE INPUT
    // ============================================
    function handleInput(input) {
        input.value = sanitizeValue(input.value);
        calc();
        debouncedAutoSave();
    }

    function handleAccontoInput() {
        calc();
        debouncedAutoSave();
    }

    function debouncedAutoSave() {
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
        }
        
        autoSaveTimeout = setTimeout(() => {
            autoSave();
        }, AUTOSAVE_DELAY);
    }

    // ============================================
    // CALCOLI
    // ============================================
    function calc() {
        let totalMese = 0;
        
        cols.forEach(c => {
            let q = 0;
            document.querySelectorAll(`input[data-c="${c}"]`).forEach(i => {
                if (i.value !== '') {
                    if (c === 'straordinari') {
                        const val = parseFloat(i.value.replace(',', '.')) || 0;
                        q += val;
                    } else {
                        q += 1;
                    }
                }
            });
            totalMese += (q * RATES[c]);
        });
        
        const acc = parseFloat(document.getElementById('acc').value) || 0;
        const resto = totalMese - acc;
        
        document.getElementById('totM').value = totalMese > 0 ? '‚Ç¨ ' + totalMese.toFixed(2) : '';
        document.getElementById('res').value = (totalMese > 0 || acc > 0) ? '‚Ç¨ ' + resto.toFixed(2) : '';
        
        let totA = 0;
        const data = loadFromStorage();
        
        if (data[curYear]) {
            for (let m = 0; m < 12; m++) {
                if (m === curMonth) { 
                    totA += resto; 
                } else if (data[curYear][m]) {
                    let mTot = 0;
                    const mData = data[curYear][m];
                    
                    cols.forEach(c => {
                        let q = 0;
                        Object.keys(mData.v).forEach(k => { 
                            if (k.endsWith('-' + c)) {
                                if (c === 'straordinari') {
                                    q += parseFloat(mData.v[k]) || 0;
                                } else {
                                    q += 1;
                                }
                            }
                        });
                        mTot += (q * RATES[c]);
                    });
                    
                    totA += (mTot - (parseFloat(mData.a) || 0));
                }
            }
        } else { 
            totA = resto; 
        }
        
        document.getElementById('ann').value = totA !== 0 ? '‚Ç¨ ' + totA.toFixed(2) : '';
    }

    // ============================================
    // SALVATAGGIO AUTOMATICO
    // ============================================
    function autoSave() {
        try {
            let data = loadFromStorage();
            
            if (!data[curYear]) data[curYear] = {};
            if (!data[curYear][curMonth]) data[curYear][curMonth] = { v: {}, a: 0 };
            
            let currentValues = {};
            document.querySelectorAll('input[data-d]').forEach(i => {
                if (i.value !== '') {
                    currentValues[i.dataset.d + '-' + i.dataset.c] = sanitizeValue(i.value);
                }
            });
            
            data[curYear][curMonth].v = currentValues;
            data[curYear][curMonth].a = document.getElementById('acc').value;
            
            if (saveToStorage(data)) {
                console.log('‚úÖ Autosalvataggio completato');
            }
        } catch (e) {
            console.error('Errore autosalvataggio:', e);
        }
    }

    // ============================================
    // CARICAMENTO DATI
    // ============================================
    function load() {
        const data = loadFromStorage();
        console.log('üìÇ Caricamento dati per anno:', curYear, 'mese:', curMonth);
        
        if (data[curYear] && data[curYear][curMonth]) {
            const mData = data[curYear][curMonth];
            console.log('‚úÖ Dati trovati per il mese corrente:', mData);
            
            let loadedCount = 0;
            Object.keys(mData.v).forEach(k => {
                const [d, c] = k.split('-');
                const inp = document.querySelector(`input[data-d="${d}"][data-c="${c}"]`);
                if (inp) {
                    inp.value = mData.v[k];
                    loadedCount++;
                }
            });
            
            console.log(`üìä Caricati ${loadedCount} valori`);
            
            const accInput = document.getElementById('acc');
            if (accInput) {
                accInput.value = mData.a || '';
            }
        } else {
            console.log('‚ÑπÔ∏è Nessun dato per questo mese');
        }
        
        calc();
    }

    // ============================================
    // ESPORTAZIONE/IMPORTAZIONE
    // ============================================
    function exportData() {
        try {
            const dataStr = localStorage.getItem(STORAGE_KEY);
            if (!dataStr) {
                showToast('‚ö†Ô∏è Nessun dato da esportare', 'error');
                return;
            }
            
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const now = new Date();
            const dateStr = now.toLocaleDateString('it-IT').replace(/\//g, '-');
            const timeStr = now.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'}).replace(/:/g, '-');
            
            a.href = url;
            a.download = `Calendario_Presenze_${dateStr}_${timeStr}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('‚úÖ Backup esportato!', 'success');
        } catch (e) {
            console.error('Errore esportazione:', e);
            showToast('‚ùå Errore esportazione', 'error');
        }
    }

    function importData(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.name.endsWith('.json')) {
            showToast('‚ö†Ô∏è Seleziona un file .json', 'error');
            e.target.value = '';
            return;
        }
        
        const reader = new FileReader();
        
        reader.onload = (ev) => {
            try {
                let importedData;
                try {
                    importedData = JSON.parse(ev.target.result);
                } catch (parseError) {
                    showToast('‚ùå File JSON non valido', 'error');
                    e.target.value = '';
                    return;
                }
                
                if (!validateData(importedData)) {
                    showToast('‚ùå Struttura dati non valida', 'error');
                    e.target.value = '';
                    return;
                }
                
                const existingData = localStorage.getItem(STORAGE_KEY);
                if (existingData) {
                    if (!confirm('‚ö†Ô∏è Sovrascrivere i dati esistenti?')) {
                        e.target.value = '';
                        return;
                    }
                }
                
                if (saveToStorage(importedData)) {
                    load();
                    showToast('‚úÖ Dati importati!', 'success');
                } else {
                    throw new Error('Errore salvataggio');
                }
            } catch (error) {
                console.error('Errore importazione:', error);
                showToast('‚ùå Errore importazione', 'error');
            } finally {
                e.target.value = '';
            }
        };
        
        reader.onerror = () => {
            showToast('‚ùå Errore lettura file', 'error');
            e.target.value = '';
        };
        
        reader.readAsText(file);
    }

    // ============================================
    // AVVIO APPLICAZIONE
    // ============================================
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }

    window.addEventListener('beforeunload', (e) => {
        if (autoSaveTimeout) {
            clearTimeout(autoSaveTimeout);
            autoSave();
        }
    });
</script>
</body>
</html>
